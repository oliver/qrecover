<!DOCTYPE html>
<html>
    <meta charset="utf-8"/>
    <title>QRecover</title>

    <script src="error_correction.js"></script>
    <script src="main_canvas.js"></script>
    <script src="preview_image.js"></script>
    <script src="area_list.js"></script>
    <script src="static_areas.js"></script>
    <script src="pixel_data.js"></script>
    <script src="decoder.js"></script>

    <script type="text/javascript">
    var code_size = 25;
    var pixel_size = 20;

    var highlighted_area = null;
    var highlighted_differences = null;


    function highlight_area (area) {
        if (highlighted_area) {
            for (const [element_location_id, element] of highlighted_area.dom_elements) {
                element.style.outline = "";
            }
        }

        highlighted_area = area;

        if (highlighted_area) {
            for (const [element_location_id, element] of highlighted_area.dom_elements) {
                element.style.outline = "3px solid red";
            }
        }
        draw_code();
    }

    function init() {
        init_pixel_data();
        update_load_button();

        add_static_areas();
        update_static_area_cache();

        init_main_canvas(document.getElementById("can"), document.getElementById("mouse_pos"));
        init_preview_image(document.getElementById("preview_canvas"), document.getElementById("preview_image"));

        if (!restore_state()) {
            load_from_img_object(document.getElementById('img_example_code'));
        }
        decode();
        draw_code();
    }

    const error_correction_levels = {
        2: "H / High",
        3: "Q / Quartile",
        0: "M / Medium",
        1: "L / Low"
    };


    function update_area_details_list () {
        var table_body = document.getElementById("area_table_body");
        table_body.innerHTML = "";

        for (const [id, area] of get_all_areas().entries()) {
            var new_row = table_body.insertRow();
            area.dom_elements.set("area_table_div", new_row);
            new_row.addEventListener("mouseover", function (e) {
                highlight_area(area);
            });
            new_row.addEventListener("mouseout", function (e) {
                highlight_area(null);
            });

            if (highlighted_area && id == highlighted_area.id) {
                highlighted_area = area;
            }

            var result_obj;
            try {
                result_obj = area.check_function(area);
            } catch (ex) {
                result_obj = {"valid": false, "desc": "Error: " + ex};
                if (ex.hasOwnProperty("x")) {
                    result_obj.desc = "Invalid Pixel at (" + ex.x + "/" + ex.y + ")";
                } else if (ex.desc) {
                    result_obj.desc = "Error</span> (" + ex.desc + ")";
                } else {
                    result_obj.desc = "Invalid Pixels (" + ex + ")";
                }
            }

            function add_cell (obj, func) {
                var cell = new_row.insertCell();
                if (obj !== undefined) {
                    func(cell);
                } else {
                    cell.innerHTML = "&nbsp;";
                }
                return cell;
            }

            add_cell(result_obj["offset"], (cell) => { cell.innerHTML = result_obj["offset"]; }).style.textAlign = "right";
            add_cell(id, (cell) => { cell.innerHTML = id; });

            add_cell(result_obj["value"], (cell) => { cell.innerHTML = result_obj["value"]; }).style.textAlign = "right";
            var num_hex_digits = Math.ceil(result_obj["num_bits"] / 4);
            add_cell(result_obj["value"], (cell) => { cell.innerHTML = "0x" + result_obj["value"].toString(16).padStart(num_hex_digits,"0"); }).style.textAlign = "right";
            var num_bin_digits = result_obj["num_bits"];
            add_cell(result_obj["value"], (cell) => { cell.innerHTML = result_obj["value"].toString(2).padStart(num_bin_digits,"0"); }).style.textAlign = "right";

            add_cell(result_obj["valid"], (cell) => {
                cell.innerHTML = (result_obj["valid"] ? "\u2713" : "\u2718");
                cell.style.textAlign = "center";
                cell.style.color = (result_obj["valid"] ? "green" : "white");
                cell.style.backgroundColor = (result_obj["valid"] ? "" : "red");
            });
            add_cell(result_obj["desc"], (cell) => { cell.innerHTML = result_obj["desc"] });
        }
    }

    function decode () {
        decode_inner();
        update_area_details_list();
        perform_global_checks();

        // restore highlight in newly-populated area list:
        highlight_area(highlighted_area);
    }

    function perform_global_checks () {
        const ec_1_value = static_areas.get("format_ec_1").check_function(static_areas.get("format_ec_1")).value;
        const mask_1_value = static_areas.get("format_mask_1").check_function(static_areas.get("format_mask_1")).value;
        const ec_data_1_value = static_areas.get("format_ec_data_1").check_function(static_areas.get("format_ec_data_1")).value;
        const full_ec_1_bits = (ec_1_value << 13) | (mask_1_value << 10) | ec_data_1_value;
        const check_result_1 = check_format_ec(full_ec_1_bits);

        const ec_2_value = static_areas.get("format_ec_2").check_function(static_areas.get("format_ec_2")).value;
        const mask_2_value = static_areas.get("format_mask_2").check_function(static_areas.get("format_mask_2")).value;
        const ec_data_2_value = static_areas.get("format_ec_data_2").check_function(static_areas.get("format_ec_data_2")).value;
        const full_ec_2_bits = (ec_2_value << 13) | (mask_2_value << 10) | ec_data_2_value;
        const check_result_2 = check_format_ec(full_ec_2_bits);

        if (check_result_1 != 0 || check_result_2 != 0) {
            const potential_corrections_1 = get_corrections(full_ec_1_bits);
            const potential_corrections_2 = get_corrections(full_ec_2_bits);

            // create list of best corrections, taking both format info sections into account:
            var combined_corrections = new Array();
            for (var {code, distance} of potential_corrections_1) {
                const matching_element_in_2 = potential_corrections_2.find(element => (element.code == code));
                combined_corrections.push({"code": code, "distance_sum": distance + matching_element_in_2.distance});
            }

            combined_corrections.sort((a,b) => {
                if (a.distance_sum != b.distance_sum) {
                    return a.distance_sum - b.distance_sum;
                } else {
                    return a.code - b.code;
                }
            });

            var new_list_element = document.createElement("li");
            new_list_element.innerHTML = "Format data has invalid checksum. Possible corrections:";
            document.getElementById("error_list").appendChild(new_list_element);
            var new_sub_list = document.createElement("ul");
            new_list_element.appendChild(new_sub_list);

            for (var {code, distance_sum} of combined_corrections) {
                const replacement_code = code;
                let replacements = new Array();

                const all_regions_1 = static_areas.get("format_ec_1").regions.concat(static_areas.get("format_mask_1").regions, static_areas.get("format_ec_data_1").regions);
                const all_regions_2 = static_areas.get("format_ec_2").regions.concat(static_areas.get("format_mask_2").regions, static_areas.get("format_ec_data_2").regions);
                const num_bits = 15;
                const replacement_code_masked = replacement_code ^ 0b101010000010010;
                for (var i = 0; i < num_bits; i++) {
                    const bit = (replacement_code_masked >> (num_bits - i - 1)) & 1;
                    const [x_1, y_1] = pixel_at_bit_offset(all_regions_1, i);
                    replacements.push({"x": x_1, "y": y_1, "value": bit});
                    const [x_2, y_2] = pixel_at_bit_offset(all_regions_2, i);
                    replacements.push({"x": x_2, "y": y_2, "value": bit});
                }

                const ec_value = (replacement_code >> 13) & 0b11;
                const mask_value = (replacement_code >> 10) & 0b111;
                const payload_bits = (replacement_code >> 10) & 0b11111;

                var item_text = "<span style='text-decoration: underline dashed;'>"
                    + payload_bits.toString(2).padStart(5,"0")
                    + " = EC: " + error_correction_levels[ec_value] + ", mask: " + mask_value
                    + " (" + distance_sum + " bit(s) differ) <button>Apply</button></span>";

                var new_sub_item = document.createElement("li");
                new_sub_item.innerHTML = item_text;
                new_sub_list.appendChild(new_sub_item);

                const span = new_sub_item.querySelector("span");
                span.addEventListener("mouseover", function (e) {
                    show_correction(replacements);
                }, false);
                span.addEventListener("mouseout", function (e) {
                    show_correction(null);
                }, false);

                const button = new_sub_item.querySelector("button");
                button.addEventListener("click", function (e) {
                    apply_correction(replacements);
                    show_correction(null);
                }, false);
            }
        }
    }

    function show_correction (replacements) {
        highlighted_differences = replacements;
        draw_code();
    }

    function apply_correction (replacements) {
        for ({x, y, value} of replacements) {
            pixel_data[x][y] = value;
        }
        decode();
        draw_code();
        save_state();
    }


    function load_from_file (img_input_field) {
        const [file] = img_input_field.files;
        if (file) {
            var img_obj = new Image();
            img_obj.src = URL.createObjectURL(file);
            img_obj.onload = function () {
                load_from_img_object(img_obj);
            }
        }
    }

    function load_from_img_object (img_obj) {
        var img_canvas = document.createElement("canvas");
        img_canvas.width = img_obj.width;
        img_canvas.height = img_obj.height;
        img_canvas.getContext("2d").drawImage(img_obj, 0, 0, img_obj.width, img_obj.height);
        var image_pixel_data = img_canvas.getContext("2d").getImageData(0, 0, img_obj.width, img_obj.height).data;

        for (var x = 0; x < Math.min(img_obj.width, code_size); x++) {
            for (var y = 0; y < Math.min(img_obj.height, code_size); y++) {
                const red_value = image_pixel_data[(y*img_obj.width + x) * 4];
                pixel_data[x][y] = (red_value < 128) ? true : false;
            }
        }
        save_state();
        decode();
        draw_code();
    }

    function update_load_button () {
        document.getElementById("btn_load_image").disabled = (document.getElementById("imgInp").files.length != 1);
    }
    </script>

    <body onload="init()">
        <div style="display: flex; align-items: flex-start; justify-content: space-between;">
        <div>
        <form>
            <input accept="image/*" type="file" id="imgInp" onchange="update_load_button();" />
            <input type="button" id="btn_load_image" value="Load Selected File" onclick="load_from_file(this.form.imgInp)">
        </form>
        Mask Display:
        <input type="radio" name="mask_mode" id="rb_show_masked" onchange="draw_code()" checked><label for="rb_show_masked">Masked</label>
        <input type="radio" name="mask_mode" id="rb_show_unmasked" onchange="draw_code()"><label for="rb_show_unmasked">Unmasked</label>
        <input type="radio" name="mask_mode" id="rb_show_mask" onchange="draw_code()"><label for="rb_show_mask">Mask Itself</label>
        <br>
        Numbers:
        <input type="radio" name="numbering_mode" id="rb_numbers_none" onchange="draw_code()" checked><label for="rb_numbers_none">Hide</label>
        <input type="radio" name="numbering_mode" id="rb_numbers_per_area" onchange="draw_code()"><label for="rb_numbers_per_area">Show for each area</label>
        <input type="radio" name="numbering_mode" id="rb_numbers_data_bits" onchange="draw_code()"><label for="rb_numbers_data_bits">Show for data bits</label>
        <br>
        <input type="checkbox" id="cb_colors_enabled" onchange="draw_code()" checked><label for="cb_colors_enabled">Color areas</label>
        <input type="checkbox" id="cb_outlines_enabled" onchange="draw_code()" checked><label for="cb_outlines_enabled">Show Outlines</label>
        <input type="checkbox" id="cb_grid_enabled" onchange="draw_code()" checked><label for="cb_grid_enabled">Show Grid</label>
        <br>
        <br>
        </div>

            <div>
                <canvas id="preview_canvas" style="display: none"></canvas>
                <img id="preview_image" title="Preview of edited QR code" style="image-rendering: crisp-edges;">
            </div>
        </div>

        <div style="display: flex; align-items: flex-start;">
            <div>
                <canvas id="can"></canvas>
                <br>
                <div id="mouse_pos">&nbsp;</div>
                <br>
                <div id="text_payload"></div>
                <br>
                <ul id="error_list" style="height: 18vh; overflow: scroll"></ul>
            </div>

            <div style="height: 85vh; overflow: scroll">
                <table id="area_table" style="margin-left: 20px">
                    <thead>
                        <tr>
                            <th>Offset</th>
                            <th>Name</th>
                            <th>Value (Dec)</th>
                            <th>Value (Hex)</th>
                            <th>Value (Bin)</th>
                            <th>Valid</th>
                            <th>Description</th></tr>
                    </thead>
                    <tbody id="area_table_body">
                    </tbody>
                </table>
            </div>
        </div>

        <img id="img_example_code" style="display: none" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAABQUlEQVRIS61W0RKDIAwD/f9Pxmk9y8WYQrmbT7Mgbdoko9Zaf9dT1OPxa09Reyxuj635bz7H4rZLJvGD1UFRwijek2AlXhki8QoZHRbDiPx9moSRcLV/SeIIuH0jZLiWnolqH5KB13H4PYmkFrAGD1HtGbHLzo75G2SezUh9dg+eF6LKGBFqZIjWRIL9VcLLijGi/t0u1sjdR1IzohuJUemtJ5kxJCNGbl+nv89kRd1M0a7syOPcu9jguD0ZMToSqRNlFaxaPMAL2ratHMfRnRhn+dqPLozDVpYdoVPWg+3/WH3UNuW+iASLYs1MFT9Dx3NgTS17l6KxUv2n1TgTRc0oxkbJc3l9pyg88yhOjO/7vpfW2utOkPpnRIozMXz4TAyk83KSjK+x76VvKzjgSNnKhZ/Y+N4V3WI+1T6+pVp7AmL1+/532aUIAAAAAElFTkSuQmCC">
    </body>
    </html>
