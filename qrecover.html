<!DOCTYPE html>
<html>
    <meta charset="utf-8"/>

    <script type="text/javascript">
    var code_size = 25;
    var pixel_size = 20;
    var pixel_data = new Array(code_size);
    for (var i = 0; i < pixel_data.length; i++) {
        pixel_data[i] = new Array(code_size);
        pixel_data[i].fill(false);
    }

    var canvas, ctx;

    function init() {
        canvas = document.getElementById('can');
        canvas.width = code_size*pixel_size;
        canvas.height = code_size*pixel_size;
        ctx = canvas.getContext("2d");

        draw_code();
        canvas.addEventListener("mousedown", function (e) {
            var [pix_x, pix_y] = event_to_pixel(e);
            toggle_pixel(pix_x, pix_y);
        }, false);
    }

    function draw_grid () {
        ctx.strokeStyle = "black";
        ctx.lineWidth = 1;
        for (i = 0; i < code_size; i++) {
            ctx.beginPath();
            ctx.moveTo(i * pixel_size, 0);
            ctx.lineTo(i * pixel_size, code_size*pixel_size);
            ctx.stroke();
            ctx.closePath();

            ctx.beginPath();
            ctx.moveTo(0, i * pixel_size);
            ctx.lineTo(code_size * pixel_size, i*pixel_size);
            ctx.stroke();
            ctx.closePath();
        }
    }

    function event_to_pixel (e) {
        var pix_x = Math.floor((e.clientX - canvas.offsetLeft) / pixel_size);
        var pix_y = Math.floor((e.clientY - canvas.offsetTop) / pixel_size);
        return [pix_x, pix_y];
    }

    function toggle_pixel (px, py) {
        var set_pixel = !(pixel_data[px][py]);
        pixel_data[px][py] = set_pixel;
        draw_code();
    }

    function draw_code () {
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, code_size*pixel_size, code_size*pixel_size);

        for (var x = 0; x < code_size; x++) {
            for (var y = 0; y < code_size; y++) {
                draw_pixel(x, y, pixel_data[x][y]);
            }
        }
        draw_grid();

        // draw code areas
        ctx.fillStyle = "rgba(0, 255, 0, 0.5)";
        ctx.fillRect(0, 0, 7*pixel_size, 7*pixel_size);
        ctx.fillRect((code_size-7)*pixel_size, 0, 7*pixel_size, 7*pixel_size);
        ctx.fillRect(0, (code_size-7)*pixel_size, 7*pixel_size, 7*pixel_size);

        ctx.fillRect(16*pixel_size, 16*pixel_size, 5*pixel_size, 5*pixel_size);
    }

    function draw_pixel (px, py, set_pixel) {
        ctx.beginPath();
        ctx.fillStyle = set_pixel ? "black" : "white";
        ctx.fillRect(px*pixel_size, py*pixel_size, pixel_size, pixel_size);
        ctx.closePath();
    }

    function load_from_file (img_input_field) {
        const [file] = img_input_field.files;
        if (file) {
            var img_obj = new Image();
            img_obj.src = URL.createObjectURL(file);
            img_obj.onload = function () {
                var img_canvas = document.createElement("canvas");
                img_canvas.width = img_obj.width;
                img_canvas.height = img_obj.height;
                img_canvas.getContext("2d").drawImage(img_obj, 0, 0, img_obj.width, img_obj.height);
                var image_pixel_data = img_canvas.getContext("2d").getImageData(0, 0, img_obj.width, img_obj.height).data;

                for (var x = 0; x < Math.min(img_obj.width, code_size); x++) {
                    for (var y = 0; y < Math.min(img_obj.height, code_size); y++) {
                        const red_value = image_pixel_data[(y*img_obj.width + x) * 4];
                        pixel_data[x][y] = (red_value < 128) ? true : false;
                    }
                }
                draw_code();
            }
        }
    }
    </script>

    <body onload="init()">
        <canvas id="can" style="position:absolute;top:10%;left:10%;border:2px solid;"></canvas>
        <form>
            <input accept="image/*" type="file" id="imgInp" />
            <input type="button" value="Load Selected File" onclick="load_from_file(this.form.imgInp)">
        </form><br>
        <form>
            <input type="button" value="Export Pixels">
        </form>
    </body>
    </html>
